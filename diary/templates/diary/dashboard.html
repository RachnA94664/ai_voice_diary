{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - AI Voice Diary (Advanced){% endblock %}

{% block content %}
<!-- Sidebar Overlay -->
<!-- <div class="sidebar-overlay" id="sidebarOverlay"></div> -->

<!-- ADVANCED SIDEBAR -->
<aside class="sidebar" id="sidebar">
    <nav>

        <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <a href="/diary/dashboard/" class="nav-link">
                <i class="fas fa-home"></i><span>Dashboard</span>
            </a>

            <a href="/diary/record/" class="nav-link">
                <i class="fas fa-microphone"></i><span>New Entry</span>
            </a>

            <a href="/diary/entries/" class="nav-link">
                <i class="fas fa-book"></i><span>My Entries</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Analytics</div>
            <a href="/insights/" class="nav-link">
                <i class="fas fa-chart-line"></i><span>Insights</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Account</div>
            <a href="/accounts/profile/" class="nav-link">
                <i class="fas fa-user"></i><span>Profile</span>
            </a>

            <a href="/accounts/settings/" class="nav-link">
                <i class="fas fa-cog"></i><span>Settings</span>
            </a>
        </div>

    </nav>
</aside>


<!-- NAVBAR -->
<nav class="top-navbar">
    <div class="left-group">
        <button id="sidebarToggle" class="icon-btn">
            <i class="fas fa-bars"></i>
        </button>

        <a href="/diary/dashboard/" class="brand">
            <i class="fas fa-microphone-alt brand-icon"></i>
            <span>AI Voice Diary</span>
        </a>
    </div>

    <div class="right-group">
        <button class="icon-btn" title="Notifications">
            <i class="fas fa-bell"></i>
        </button>

        {% if user.is_authenticated %}
        <div class="dropdown">
            <button class="icon-btn dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-user"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end glass-dropdown">
                <li>
                    <a class="dropdown-item" href="/accounts/profile/">
                        <i class="fas fa-user me-2"></i> Profile
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="/accounts/logout/">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
        {% else %}
        <a href="/accounts/login/" class="login-btn">
            <i class="fas fa-sign-in-alt me-2"></i> Login
        </a>
        {% endif %}
    </div>
</nav>


<!-- Main Content -->
<main class="main-content">
    <!-- Page Header -->
    <div style="margin-bottom: 2rem; display:flex; justify-content:space-between; align-items:center; gap:1rem;">
        <div>
            <h1 style="font-size: 2.25rem; font-weight: 700; margin-bottom: 0.25rem;">
                Welcome back{% if user.first_name %}, {{ user.first_name }}{% endif %}! ðŸ‘‹
            </h1>
            <p style="color: #6b7280; font-size: 1rem; margin:0;">Here's what's happening with your voice diary today.</p>
        </div>

        <!-- Quick actions -->
        <div style="display:flex; gap:0.5rem;">
            <a href="/diary/record/" class="btn-primary-custom"><i class="fas fa-microphone me-2"></i>Record</a>
            <button id="openChatBtn" class="btn-secondary-custom"><i class="fas fa-robot me-2"></i>Analyze (Chat)</button>
        </div>
    </div>

    <!-- Stats Cards (simplified) -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-book"></i></div>
            <div class="stat-value" id="totalEntries">{{ total_entries|default:0 }}</div>
            <div class="stat-label">Total Entries</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-wallet"></i></div>
            <div class="stat-value" id="totalExpenses">â‚¹{{ total_expenses|default:0 }}</div>
            <div class="stat-label">Total Expenses</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-value" id="avgEntryLength">â€”</div>
            <div class="stat-label">Avg Entry Length</div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Recorder + Chatbot -->
        <div class="col-lg-7 mb-4">
            <div class="card-custom">
                <h3 class="card-title"><i class="fas fa-microphone"></i> Record & Submit</h3>

                <div class="recording-container">
                    <!-- Mode Toggle -->
                    <div class="mode-toggle">
                        <button class="mode-btn active" id="voiceModeBtn"><i class="fas fa-microphone me-2"></i>Voice</button>
                        <button class="mode-btn" id="textModeBtn"><i class="fas fa-keyboard me-2"></i>Text</button>
                    </div>

                    <!-- Voice Input: implements MediaRecorder, uploads audio to backend -->
                    <div id="voiceInputArea">
                        <div style="display:flex; align-items:center; gap:1rem;">
                            <button id="recordButton" class="record-button" aria-pressed="false">
                                <i class="fas fa-microphone" id="recordIcon"></i>
                            </button>

                            <div>
                                <div id="statusText" style="color:#6b7280;">Click the microphone to start recording</div>
                                <div id="recordingTime" style="display:none; font-weight:600;">00:00</div>
                            </div>
                        </div>

                        <div style="margin-top:1rem; display:flex; gap:0.5rem;">
                            <select id="languageSelect" aria-label="Recording language">
                                <option value="en-US">English (US)</option>
                                <option value="en-IN">English (India)</option>
                                <option value="hi-IN">Hindi</option>
                                <!-- Add more language options as supported by your speech-to-text backend -->
                            </select>

                            <button id="uploadLocalBtn" class="btn-secondary-custom">Upload audio</button>
                        </div>

                        <div id="recordingPreview" style="margin-top:1rem;"></div>
                    </div>

                    <!-- Text Input: large editor area -->
                    <div id="textInputArea" style="display:none;">
                        <form id="textEntryForm" method="post" action="/diary/create-text-entry/">
                            {% csrf_token %}
                            <textarea name="content" id="textEntry" rows="8" placeholder="Type your diary entry here..." maxlength="5000" style="width:100%; padding:1rem; border-radius:12px; background:#f8fafc; border:1px solid #e6eef6;"></textarea>

                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:0.5rem;">
                                <div style="color:#6b7280;"> <span id="charCount">0</span> / 5000</div>
                                <div style="display:flex; gap:0.5rem;">
                                    <button type="button" class="btn-secondary-custom" onclick="clearTextEntry()"><i class="fas fa-eraser me-2"></i>Clear</button>
                                    <button type="submit" class="btn-primary-custom"><i class="fas fa-paper-plane me-2"></i>Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>

                </div>

                <hr />

                <!-- Chatbot panel (collapsible) -->
                <div id="chatPanel" style="display:none;">
                    <h4><i class="fas fa-robot"></i> Diary Chat Analyst</h4>
                    <p style="color:#6b7280;">Ask the assistant about your diary (summary, mood trends, highlights). The assistant can access only your entries.</p>

                    <div id="chatWindow" style="height:320px; overflow:auto; border:1px solid #e6eef6; padding:1rem; border-radius:8px; background:#ffffff;">
                        <!-- messages will be injected here -->
                    </div>

                    <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                        <input id="chatInput" type="text" placeholder="Ask something about your diary (e.g. 'show last week's highlights')" style="flex:1; padding:0.5rem; border-radius:8px; border:1px solid #e6eef6;" />
                        <button id="sendChatBtn" class="btn-primary-custom">Send</button>
                    </div>

                </div>

            </div>
        </div>

        <!-- Right Column: Recent Activity + Filters -->
        <div class="col-lg-5 mb-4">
            <div class="card-custom">
                <h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3>

                <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                    <input id="filterQuery" type="text" placeholder="Search content..." style="flex:1; padding:0.5rem; border-radius:8px; border:1px solid #e6eef6;" />
                    <input id="filterDate" type="date" style="padding:0.5rem; border-radius:8px; border:1px solid #e6eef6;" />
                    <button id="applyFilterBtn" class="btn-secondary-custom">Filter</button>
                </div>

                <div id="activityList" class="activity-list" style="max-height:420px; overflow:auto;">
                    <!-- Entry items inserted by JS -->
                </div>

                <div style="display:flex; gap:0.5rem; justify-content:center; margin-top:1rem;">
                    <button id="exportCsvBtn" class="btn-secondary-custom">Export CSV</button>
                    <a href="/diary/entries/" class="btn-secondary-custom">View All</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Entries Table (paginated) -->
    <div class="card-custom">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3 class="card-title"><i class="fas fa-table"></i> Recent Diary Entries</h3>
            <div>
                <button id="bulkDeleteBtn" class="btn-secondary-custom" style="display:none;">Delete Selected</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table-custom" id="entriesTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" /></th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Preview</th>
                        <th>Expenses</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesTbody">
                    <!-- populated by JS -->
                </tbody>
            </table>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem;">
            <div id="paginationInfo"></div>
            <div>
                <button id="prevPage" class="btn-secondary-custom">Prev</button>
                <button id="nextPage" class="btn-secondary-custom">Next</button>
            </div>
        </div>
    </div>
</main>

{% endblock %}

{% block extra_js %}
<script>
/*
    Advanced front-end behaviours implemented below.
    Backend expectations (you must implement these endpoints in Django REST Framework or regular Django views):
     - GET  /api/entries/?page=1&query=...         -> returns paginated JSON list of user's entries
     - POST /api/entries/voice/                   -> accepts multipart/form-data with audio file, language -> returns created entry JSON
     - POST /api/entries/text/                    -> accepts JSON/text body to create a text entry
     - POST /api/chat-analyze/                    -> accepts {query: string, entry_ids?: []} -> returns assistant response
     - GET  /api/entries/export_csv/              -> returns CSV of filtered entries

    Recommended backend packages: djangorestframework, django-cors-headers, django-storages (if using S3), celery + redis for background transcription/analysis.
*/

// Sidebar toggle
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');
sidebarToggle?.addEventListener('click', () => sidebar.classList.toggle('open'));

// Mode toggle logic
const voiceModeBtn = document.getElementById('voiceModeBtn');
const textModeBtn = document.getElementById('textModeBtn');
const voiceInputArea = document.getElementById('voiceInputArea');
const textInputArea = document.getElementById('textInputArea');

voiceModeBtn?.addEventListener('click', () => {
    voiceModeBtn.classList.add('active');
    textModeBtn.classList.remove('active');
    voiceInputArea.style.display = 'block';
    textInputArea.style.display = 'none';
});

textModeBtn?.addEventListener('click', () => {
    textModeBtn.classList.add('active');
    voiceModeBtn.classList.remove('active');
    textInputArea.style.display = 'block';
    voiceInputArea.style.display = 'none';
});

// Character counter for text editor
const textEntry = document.getElementById('textEntry');
const charCount = document.getElementById('charCount');
function updateCharCount() {
    if (textEntry && charCount) charCount.textContent = textEntry.value.length;
}
textEntry?.addEventListener('input', updateCharCount);
function clearTextEntry(){ if (textEntry){ textEntry.value=''; updateCharCount(); }}

// Recording: MediaRecorder support with in-browser preview and upload
let mediaRecorder;
let recordedChunks = [];
let isRecording = false;
let recordingInterval;
let seconds = 0;
const recordButton = document.getElementById('recordButton');
const recordIcon = document.getElementById('recordIcon');
const statusText = document.getElementById('statusText');
const recordingTime = document.getElementById('recordingTime');
const recordingPreview = document.getElementById('recordingPreview');

async function startMedia() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = handleRecordingStop;
    } catch (err) {
        console.error('microphone error', err);
        statusText.textContent = 'Microphone access denied or not available.';
    }
}

async function handleRecordingStop(){
    // create blob and a playable preview
    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
    recordedChunks = [];
    const url = URL.createObjectURL(blob);
    recordingPreview.innerHTML = '';
    const audio = document.createElement('audio'); audio.controls = true; audio.src = url; audio.style.width='100%';
    recordingPreview.appendChild(audio);

    // upload to backend
    statusText.textContent = 'Uploading audio for transcription...';
    const formData = new FormData();
    formData.append('audio', blob, 'entry.webm');
    formData.append('language', document.getElementById('languageSelect')?.value || 'en-US');

    try {
        const res = await fetch('/api/entries/voice/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        if (!res.ok) throw new Error('Upload failed');
        const data = await res.json();
        statusText.textContent = 'Entry saved.';
        // refresh UI
        loadEntries();
    } catch (err) {
        console.error(err);
        statusText.textContent = 'Upload failed. Try again.';
    }
}

recordButton?.addEventListener('click', async () => {
    if (!mediaRecorder) await startMedia();
    if (!mediaRecorder) return;

    if (!isRecording) {
        recordedChunks = [];
        mediaRecorder.start();
        isRecording = true;
        recordButton.classList.add('recording');
        recordIcon.className = 'fas fa-stop';
        statusText.textContent = 'Recording... Click to stop.';
        recordingTime.style.display = 'block';
        seconds = 0;
        recordingInterval = setInterval(()=>{
            seconds++;
            const mins = Math.floor(seconds/60); const secs = seconds%60;
            recordingTime.textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
        },1000);
    } else {
        mediaRecorder.stop();
        isRecording = false;
        recordButton.classList.remove('recording');
        recordIcon.className = 'fas fa-microphone';
        statusText.textContent = 'Processing...';
        recordingTime.style.display = 'none';
        clearInterval(recordingInterval);
    }
});

// small helper to read csrf cookie
function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}

// Upload local audio file
const uploadLocalBtn = document.getElementById('uploadLocalBtn');
uploadLocalBtn?.addEventListener('click', ()=>{
    const input = document.createElement('input'); input.type='file'; input.accept='audio/*';
    input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData(); formData.append('audio', file, file.name);
        formData.append('language', document.getElementById('languageSelect')?.value || 'en-US');
        statusText.textContent = 'Uploading file...';
        try {
            const res = await fetch('/api/entries/voice/', { method:'POST', body:formData, headers:{ 'X-CSRFToken':getCookie('csrftoken') }});
            if (!res.ok) throw new Error('Upload failed');
            await res.json();
            statusText.textContent = 'Uploaded.'; loadEntries();
        } catch (err) { statusText.textContent = 'Upload failed.'; }
    };
    input.click();
});

// Chatbot (simple request-response)
const openChatBtn = document.getElementById('openChatBtn');
const chatPanel = document.getElementById('chatPanel');
const sendChatBtn = document.getElementById('sendChatBtn');
const chatWindow = document.getElementById('chatWindow');
const chatInput = document.getElementById('chatInput');
openChatBtn?.addEventListener('click', ()=>{ chatPanel.style.display = chatPanel.style.display === 'none' ? 'block' : 'none'; chatInput?.focus(); });

async function appendMessage(role, text){
    const el = document.createElement('div');
    el.style.marginBottom='0.6rem';
    el.innerHTML = `<div style="font-size:0.85rem; color:#374151;"><strong>${role}:</strong> ${escapeHtml(text)}</div>`;
    chatWindow.appendChild(el);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

sendChatBtn?.addEventListener('click', async ()=>{
    const q = chatInput.value.trim(); if (!q) return;
    appendMessage('You', q);
    chatInput.value='';
    appendMessage('Assistant', 'Thinking...');

    try {
        const res = await fetch('/api/chat-analyze/', {
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken':getCookie('csrftoken') },
            body: JSON.stringify({ query: q })
        });
        if (!res.ok) throw new Error('Chat failed');
        const data = await res.json();
        // replace the last assistant 'Thinking...' with content
        chatWindow.lastChild.innerHTML = `<div style="font-size:0.85rem; color:#111;"><strong>Assistant:</strong> ${escapeHtml(data.reply || 'No result')}</div>`;
    } catch (err) {
        console.error(err);
        chatWindow.lastChild.innerHTML = `<div style="font-size:0.85rem; color:#b91c1c;"><strong>Assistant:</strong> Error â€” try again later.</div>`;
    }
});

// Entries: fetch, render, filters, pagination
let currentPage = 1;
let totalPages = 1;
async function loadEntries(page=1, query='', date=''){
    const q = new URLSearchParams({ page, query, date }).toString();
    try {
        const res = await fetch('/api/entries/?' + q, { headers: { 'Accept': 'application/json' }});
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        renderEntries(data.results || []);
        currentPage = data.page || page;
        totalPages = data.total_pages || 1;
        document.getElementById('paginationInfo').textContent = `Page ${currentPage} / ${totalPages}`;
        document.getElementById('totalEntries').textContent = data.total || 0;
    } catch (err) {
        console.error(err);
        document.getElementById('activityList').innerHTML = '<div style="padding:1rem; color:#cbd5e1;">Could not load entries.</div>';
    }
}

function renderEntries(entries){
    const list = document.getElementById('activityList'); list.innerHTML = '';
    const tbody = document.getElementById('entriesTbody'); tbody.innerHTML = '';

    entries.forEach(entry => {
        // Activity list item
        const item = document.createElement('div'); item.style.padding='0.75rem'; item.style.borderBottom='1px solid #eef2f7';
        item.innerHTML = `
            <div style="display:flex; gap:0.75rem; align-items:flex-start;">
                <div style="width:44px;height:44px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;"><i class="fas fa-${entry.entry_type === 'voice' ? 'microphone' : 'keyboard'}"></i></div>
                <div style="flex:1;">
                    <div style="font-weight:600;">${entry.entry_type.charAt(0).toUpperCase() + entry.entry_type.slice(1)} Entry</div>
                    <div style="font-size:0.85rem;color:#6b7280;">${entry.created_at_human || entry.created_at}</div>
                    <div style="margin-top:0.5rem;color:#374151;">${(entry.transcription || entry.content || '').slice(0,200)}</div>
                </div>
            </div>
        `;
        list.appendChild(item);

        // Table row
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="checkbox" data-id="${entry.id}" class="rowCheck" /></td>
            <td>${entry.created_at_display || entry.created_at}</td>
            <td><span class="badge">${entry.entry_type}</span></td>
            <td>${(entry.transcription || entry.content || '').substring(0,80)}</td>
            <td>${entry.total_expense ? ('â‚¹'+entry.total_expense) : 'â€”'}</td>
            <td><span class="badge badge-success">Processed</span></td>
            <td>
                <button class="btn-secondary-custom viewBtn" data-id="${entry.id}"><i class="fas fa-eye"></i></button>
                <button class="btn-secondary-custom editBtn" data-id="${entry.id}"><i class="fas fa-edit"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // attach view/edit handlers
    document.querySelectorAll('.viewBtn').forEach(btn => btn.addEventListener('click', () => viewEntry(btn.dataset.id)));
    document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', () => editEntry(btn.dataset.id)));
}

function viewEntry(id){ window.location.href = `/diary/entries/${id}/`; }
function editEntry(id){ window.location.href = `/diary/entries/${id}/edit/`; }

// Pagination buttons
document.getElementById('prevPage')?.addEventListener('click', ()=>{ if (currentPage>1) loadEntries(currentPage-1);} );
document.getElementById('nextPage')?.addEventListener('click', ()=>{ if (currentPage<totalPages) loadEntries(currentPage+1);} );

// Filters
document.getElementById('applyFilterBtn')?.addEventListener('click', ()=>{
    const q = document.getElementById('filterQuery').value.trim();
    const d = document.getElementById('filterDate').value;
    loadEntries(1, q, d);
});

// Export CSV
document.getElementById('exportCsvBtn')?.addEventListener('click', ()=>{
    const q = document.getElementById('filterQuery').value.trim();
    const d = document.getElementById('filterDate').value;
    window.location.href = `/api/entries/export_csv/?query=${encodeURIComponent(q)}&date=${encodeURIComponent(d)}`;
});

// Initialization
loadEntries();

</script>
{% endblock %}
